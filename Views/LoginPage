import flet as ft
import mysql.connector

def main(page: ft.Page):
    # Configurações da janela
    page.window.maximizable = False
    page.title = "SonicBurger"
    page.horizontal_alignment = ft.CrossAxisAlignment.CENTER
    page.bgcolor = ft.Colors.AMBER_100
    page.window.width = 1080
    page.window.height = 1920
    page.window.resizable = False
    page.window.center()

    logo = ft.Image(src="assets/Group 7.png")
    mensagem = ft.Text("", color=ft.Colors.BLACK, size=32)

    def validar_e_formatar_cpf(cpf):
        # Remove qualquer caractere não numérico
        cpf = ''.join(filter(str.isdigit, str(cpf)))
        
        # Verifica se tem 11 dígitos
        if len(cpf) != 11:
            return False, "CPF inválido: deve conter 11 dígitos"
        
        # Verifica se todos os dígitos são iguais
        if cpf == cpf[0] * 11:
            return False, "CPF inválido: dígitos repetidos"
        
        # Cálculo do primeiro dígito verificador
        soma = 0
        for i in range(9):
            soma += int(cpf[i]) * (10 - i)
        digito1 = (soma * 10 % 11) % 10
        
        # Cálculo do segundo dígito verificador
        soma = 0
        for i in range(10):
            soma += int(cpf[i]) * (11 - i)
        digito2 = (soma * 10 % 11) % 10
        
        # Verifica os dígitos verificadores
        if digito1 != int(cpf[9]) or digito2 != int(cpf[10]):
            return False, "CPF inválido: dígitos verificadores incorretos"
        
        # Retorna True e o CPF formatado
        return True, f"{cpf[:3]}.{cpf[3:6]}.{cpf[6:9]}-{cpf[9:]}"

    def on_login_click(e):
        cpf_valido, cpf_resultado = validar_e_formatar_cpf(CPF.value)
        if cpf_valido:
            mensagem.value = "Corrida concluída!"
            mensagem.color = ft.Colors.GREEN
        else:
            mensagem.value = cpf_resultado
            mensagem.color = ft.Colors.RED
        page.update()

    # Campos de texto estilizados
    CPF = ft.TextField(
        label="Digite seu CPF",
        width=825,
        border_radius=10,
        border_color=ft.Colors.BLUE_900,
        focused_border_color=ft.Colors.YELLOW_400,
        text_style=ft.TextStyle(color=ft.Colors.WHITE, font_family="Arial"),
        bgcolor=ft.Colors.BLUE_700,
        icon=ft.Icons.SPEED,
        read_only=True,
    )
    Senha = ft.TextField(
        label="Digite sua senha",
        password=True,
        width=825,
        border_radius=10,
        border_color=ft.Colors.BLUE_900,
        focused_border_color=ft.Colors.YELLOW_400,
        text_style=ft.TextStyle(color=ft.Colors.WHITE, font_family="Arial"),
        bgcolor=ft.Colors.BLUE_700,
        icon=ft.Icons.LOCK,
        read_only=True,
    )

    # Funções do teclado virtual
    def add_to_input(e):
        char = e.control.text
        if CPF.focused:
            CPF.value += char
            # Validação em tempo real para o CPF
            if len(CPF.value) >= 11:
                valido, resultado = validar_e_formatar_cpf(CPF.value)
                if valido:
                    CPF.value = resultado
                    CPF.border_color = ft.Colors.GREEN
                    mensagem.value = "CPF válido!"
                    mensagem.color = ft.Colors.GREEN
                else:
                    CPF.border_color = ft.Colors.RED
                    mensagem.value = resultado
                    mensagem.color = ft.Colors.RED
        elif Senha.focused:
            Senha.value += char
        page.update()

    def backspace(e):
        if CPF.focused:
            CPF.value = CPF.value[:-1]
            if len(CPF.value) < 11:
                CPF.border_color = ft.Colors.BLUE_900
                mensagem.value = ""
        elif Senha.focused:
            Senha.value = Senha.value[:-1]
        page.update()

    def clear(e):
        if CPF.focused:
            CPF.value = ""
            CPF.border_color = ft.Colors.BLUE_900
            mensagem.value = ""
        elif Senha.focused:
            Senha.value = ""
        page.update()

    def hide_keyboard(e):
        numeric_keyboard.visible = False
        full_keyboard.visible = False
        page.update()

    # Teclado numérico (apenas números) para CPF
    numeric_keyboard = ft.Column(
    [
        # Linha 1: 7 8 9
        ft.Row(
            [
                ft.ElevatedButton(text="7", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
                ft.ElevatedButton(text="8", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
                ft.ElevatedButton(text="9", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
            ],
            alignment=ft.MainAxisAlignment.CENTER,
            spacing=10,
        ),
        # Linha 2: 4 5 6
        ft.Row(
            [
                ft.ElevatedButton(text="4", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
                ft.ElevatedButton(text="5", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
                ft.ElevatedButton(text="6", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
            ],
            alignment=ft.MainAxisAlignment.CENTER,
            spacing=10,
        ),
        # Linha 3: 1 2 3
        ft.Row(
            [
                ft.ElevatedButton(text="1", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
                ft.ElevatedButton(text="2", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
                ft.ElevatedButton(text="3", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
            ],
            alignment=ft.MainAxisAlignment.CENTER,
            spacing=10,
        ),
        # Linha 4: Apagar 0 Limpar
        ft.Row(
            [
                ft.ElevatedButton(text="Apagar", on_click=backspace, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
                ft.ElevatedButton(text="0", on_click=add_to_input, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
                ft.ElevatedButton(text="Limpar", on_click=clear, width=65, height=65,
                                  bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                  style=ft.ButtonStyle(
                                      shape=ft.RoundedRectangleBorder(radius=10),
                                      side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                  )),
            ],
            alignment=ft.MainAxisAlignment.CENTER,
            spacing=10,
        ),
    ],
    visible=False,
    spacing=10,
)

    # Teclado completo (números e letras) para Senha
    full_keyboard = ft.Column(
        [
            ft.Row(
                [ft.ElevatedButton(text=char, on_click=add_to_input, width=55, height=55,
                                   bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                   style=ft.ButtonStyle(
                                       shape=ft.RoundedRectangleBorder(radius=10),
                                       side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                   ))
                 for char in "1234567890"],
                alignment=ft.MainAxisAlignment.CENTER,
            ),
            ft.Row(
                [ft.ElevatedButton(text=char, on_click=add_to_input, width=55, height=55,
                                   bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                   style=ft.ButtonStyle(
                                       shape=ft.RoundedRectangleBorder(radius=10),
                                       side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                   ))
                 for char in "QWERTYUIOP"],
                alignment=ft.MainAxisAlignment.CENTER,
            ),
            ft.Row(
                [ft.ElevatedButton(text=char, on_click=add_to_input, width=55, height=55,
                                   bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                   style=ft.ButtonStyle(
                                       shape=ft.RoundedRectangleBorder(radius=10),
                                       side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                   ))
                 for char in "ASDFGHJKL"],
                alignment=ft.MainAxisAlignment.CENTER,
            ),
            ft.Row(
                [ft.ElevatedButton(text=char, on_click=add_to_input, width=55, height=55,
                                   bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                   style=ft.ButtonStyle(
                                       shape=ft.RoundedRectangleBorder(radius=10),
                                       side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                   ))
                 for char in "ZXCVBNM"],
                alignment=ft.MainAxisAlignment.CENTER,
            ),
            ft.Row(
                [
                    ft.ElevatedButton(text="Apagar", on_click=backspace, width=80, height=40,
                                      bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                      style=ft.ButtonStyle(
                                          shape=ft.RoundedRectangleBorder(radius=10),
                                          side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                      )),
                    ft.ElevatedButton(text="Limpar", on_click=clear, width=80, height=40,
                                      bgcolor=ft.Colors.BLUE_700, color=ft.Colors.WHITE,
                                      style=ft.ButtonStyle(
                                          shape=ft.RoundedRectangleBorder(radius=10),
                                          side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                      )),
                    ft.ElevatedButton(text="Fechar", on_click=hide_keyboard, width=80, height=40,
                                      bgcolor=ft.Colors.RED_600, color=ft.Colors.WHITE,
                                      style=ft.ButtonStyle(
                                          shape=ft.RoundedRectangleBorder(radius=10),
                                          side=ft.BorderSide(width=2, color=ft.Colors.BLACK),
                                      )),
                ],
                alignment=ft.MainAxisAlignment.CENTER,
            ),
        ],
        visible=False,
        spacing=5,
    )

    # Função para mostrar o teclado correto
    def show_keyboard(e):
        field = e.control
        if field == CPF:
            numeric_keyboard.visible = True
            full_keyboard.visible = False
            CPF.focused = True
            Senha.focused = False
        elif field == Senha:
            full_keyboard.visible = True
            numeric_keyboard.visible = False
            Senha.focused = True
            CPF.focused = False
        page.update()

    # Associando eventos de clique nos campos
    CPF.on_click = show_keyboard
    Senha.on_click = show_keyboard

    # Botão de login
    Logar = ft.ElevatedButton(
        "Correr !",
        bgcolor=ft.Colors.RED_600,
        color=ft.Colors.WHITE,
        width=790,
        height=50,
        elevation=8,
        style=ft.ButtonStyle(
            shape=ft.RoundedRectangleBorder(radius=10),
        ),
        on_click=on_login_click,
        tooltip="Corrida concluída",
    )

    running_icon = ft.Icon(
        name=ft.Icons.DIRECTIONS_RUN,
        color=ft.Colors.GREY_700,
        size=36,
    )

    button_row = ft.Row(
        controls=[running_icon, Logar],
        spacing=10,
        vertical_alignment=ft.CrossAxisAlignment.CENTER,
        alignment=ft.MainAxisAlignment.CENTER,
    )

    # Organizando os componentes
    login_form = ft.Column(
        controls=[
            logo,
            CPF,
            Senha,
            button_row,
            ft.Container(height=5),
            mensagem,
            ft.Container(height=-300),
            numeric_keyboard,
            full_keyboard,
        ],
        spacing=20,
        horizontal_alignment=ft.CrossAxisAlignment.CENTER,
    )

    # Adiciona o formulário à página
    page.add(login_form)

ft.app(target=main)





